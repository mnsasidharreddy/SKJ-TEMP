<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Price History - SKJ Jewellers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin-layout.css">
    <style>
        /* Page-specific styles only */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-container table {
            min-width: 700px;
        }
        .filter-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .filter-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        @media (min-width: 640px) {
            .filter-row {
                grid-template-columns: repeat(4, 1fr);
                align-items: end;
            }
        }
        .filter-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.35rem;
        }
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--royal-green);
            box-shadow: 0 0 0 3px rgba(0, 77, 64, 0.1);
        }
        .btn-filter {
            background: var(--royal-green);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }
        .btn-filter:hover { background: #00332a; }
        
        .btn-export {
            background: #22c55e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn-export:hover { background: #16a34a; }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .data-table thead {
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        .data-table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #475569;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            color: #1e293b;
        }
        .data-table tr:hover {
            background: #f8fafc;
        }
        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        .badge-gold { background: #fef3c7; color: #92400e; }
        .badge-silver { background: #f1f5f9; color: #475569; }
        .text-diff-positive { color: #166534; font-weight: 500; }
        .text-diff-negative { color: #991b1b; font-weight: 500; }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }
        .empty-state i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <!-- === SIDEBAR (Loaded via JS) === -->
    <div id="sidebar-container"></div>

    <!-- === MAIN CONTENT === -->
    <main class="main-content">
        <header class="bg-white shadow-sm px-8 py-4 flex justify-between items-center sticky top-0 z-40">
            <div class="min-w-0">
                <h2 class="text-2xl font-bold text-gray-800 text-truncate">Price History</h2>
                <p class="text-gray-600 text-sm">Track all price changes</p>
            </div>
            <button onclick="exportCSV()" class="btn-export flex-shrink-0">
                <i class="fas fa-download"></i>Export CSV
            </button>
        </header>

        <div class="content-wrapper">
            <!-- Filters -->
            <div class="filter-card">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="fromDate">From Date</label>
                        <input type="date" id="fromDate">
                    </div>
                    <div class="filter-group">
                        <label for="toDate">To Date</label>
                        <input type="date" id="toDate">
                    </div>
                    <div class="filter-group">
                        <label for="typeFilter">Type</label>
                        <select id="typeFilter">
                            <option value="all">All</option>
                            <option value="gold">Gold</option>
                            <option value="silver">Silver</option>
                        </select>
                    </div>
                    <button onclick="window.loadHistory()" class="btn-filter">
                        <i class="fas fa-filter"></i>Filter
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Type</th>
                                <th>24CT GOLD</th>
                                <th>22CT GOLD</th>
                                <th>8gm 22ct gold</th>
                                <th>Updated By</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- === LOAD SHARED SIDEBAR === -->
    <script src="sidebar.js"></script>

    <!-- === FIREBASE + PAGE LOGIC === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { 
            getFirestore, collection, query, orderBy, limit, getDocs, 
            where, doc, getDoc 
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { 
            getAuth, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATmseHSU3qimkm6pSCJ_xA1EL3_KiHtXs",
            authDomain: "skj-jewelry-store.firebaseapp.com",
            projectId: "skj-jewelry-store",
            storageBucket: "skj-jewelry-store.firebasestorage.app",
            messagingSenderId: "531463279637",
            appId: "1:531463279637:web:2ab8aaaa80211045252a1c",
            measurementId: "G-0S99YE5NR1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        window.firebaseAuth = auth;

        let allHistory = [];

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                    window.location.href = 'index.html';
                    return;
                }
            } catch (error) {
                console.warn('⚠️ Could not verify admin:', error.message);
            }
            loadHistory();
        });

        window.loadHistory = async function loadHistory() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>';

            try {
                const typeFilter = document.getElementById('typeFilter').value;
                const fromDateVal = document.getElementById('fromDate').value;
                const toDateVal = document.getElementById('toDate').value;

                // Default: last 10 days if no date range is set
                let fromDate, toDate;
                if (fromDateVal || toDateVal) {
                    fromDate = fromDateVal ? new Date(fromDateVal + 'T00:00:00') : null;
                    toDate   = toDateVal   ? new Date(toDateVal   + 'T23:59:59') : null;
                } else {
                    toDate   = new Date();
                    fromDate = new Date();
                    fromDate.setDate(fromDate.getDate() - 9); // today + 9 previous = 10 days
                    fromDate.setHours(0, 0, 0, 0);
                }

                // Build Firestore query with server-side date filtering
                const constraints = [orderBy('updatedAt', 'desc')];
                if (typeFilter !== 'all') constraints.push(where('type', '==', typeFilter));
                if (fromDate) constraints.push(where('updatedAt', '>=', fromDate));
                if (toDate)   constraints.push(where('updatedAt', '<=', toDate));

                const q = query(collection(db, 'priceHistory'), ...constraints);
                const snapshot = await getDocs(q);

                allHistory = [];
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-inbox"></i><p>No records found</p></td></tr>';
                    return;
                }

                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();
                    const date = data.updatedAt?.toDate() || new Date();
                    
                    let adminName = 'Unknown';
                    if (data.updatedBy) {
                        try {
                            const adminDoc = await getDoc(doc(db, 'users', data.updatedBy));
                            if (adminDoc.exists()) {
                                adminName = adminDoc.data().displayName || adminDoc.data().email || 'Unknown';
                            }
                        } catch (e) {
                            console.warn('Could not fetch admin:', e);
                        }
                    }

                    const diff = data.skjPrice - data.marketPrice;
                    
                    allHistory.push({
                        date: date.toLocaleString('en-IN'),
                        type: data.type,
                        marketPrice: data.marketPrice,
                        skjPrice: data.skjPrice,
                        diff: data.skjPrice*8,
                        admin: adminName
                    });

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="whitespace-nowrap">${date.toLocaleString('en-IN')}</td>
                        <td>
                            <span class="badge ${data.type === 'gold' ? 'badge-gold' : 'badge-silver'}">
                                ${data.type.toUpperCase()}
                            </span>
                        </td>
                        <td>₹${Number(data.marketPrice).toLocaleString('en-IN')}</td>
                        <td class="font-medium">₹${Number(data.skjPrice).toLocaleString('en-IN')}</td>
                        <!--<td class="${diff < 0 ? 'text-diff-positive' : 'text-diff-negative'}">
                            ${diff >= 0 ? '+' : ''}₹${Number(diff).toFixed(2)}
                        </td>-->
                        <td class="font-medium">₹${Number(data.skjPrice*8).toLocaleString('en-IN')}</td>
                        <td class="text-gray-500">${adminName}</td>
                    `;
                    tbody.appendChild(row);
                }

            } catch (error) {
                console.error('Error loading history:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state" style="color:#991b1b"><i class="fas fa-exclamation-circle"></i><p>Error loading data</p></td></tr>';
            }
        };

        window.exportCSV = function() {
            if (allHistory.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date', 'Time', 'Type', '24CT', '22CT', 'Difference', 'Updated By'];
            const csvContent = [
                headers.join(','),
                ...allHistory.map(row => {
                    // Split the date string into date and time parts
                    const parts = row.date.split(', ');
                    const datePart = parts[0] || row.date;
                    const timePart = parts[1] || '';
                    return [
                        `"${datePart}"`,
                        `"${timePart}"`,
                        row.type,
                        row.marketPrice,
                        row.skjPrice,
                        row.diff.toFixed(2),
                        `"${row.admin}"`
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `skj-price-history-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>
