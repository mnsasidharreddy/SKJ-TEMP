<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Analytics - SKJ Jewellers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /*:root { --royal-green: #004d40; --gold: #D4AF37; }
        .bg-royal-green { background-color: var(--royal-green); }
        .text-gold { color: var(--gold); }
        
        /* Responsive Sidebar 
        .sidebar { 
            width: 160px; 
            min-height: 100vh; 
            position: fixed; 
            left: 0; 
            top: 0; 
            z-index: 40;
            transition: transform 0.3s ease;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
        }
        
        .main-content { 
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
            }
        }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            padding: 1rem;
        }
        
        @media (min-width: 768px) {
            .card {
                padding: 1.5rem;
            }
        }
        
        .chart-container { 
            position: relative; 
            height: 250px; 
            width: 100%; 
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        
        .range-btn { 
            border-color: #e5e7eb; 
            color: #6b7280;
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }
        
        @media (min-width: 768px) {
            .range-btn {
                font-size: 0.875rem;
                padding: 0.5rem 1rem;
            }
        }
        
        .range-btn:hover { 
            background-color: #f9fafb; 
            border-color: var(--gold); 
        }
        
        .range-btn.active { 
            background-color: var(--royal-green); 
            color: var(--gold); 
            border-color: var(--royal-green); 
        }
        
        #admin-panel { display: none; }
        
        

        .active-nav {
    background: linear-gradient(90deg, rgba(212, 175, 55, 0.3) 0%, rgba(255, 255, 255, 0.1) 100%) !important;
    border-left-color: #D4AF37 !important;
    color: #D4AF37 !important;
    font-weight: 700;
}
.active-nav i,
.active-nav span {
    color: #D4AF37 !important;
}

/* FORCE SIDEBAR VISIBLE ON ALL SCREENS - Override admin-layout.css 
@media (max-width: 1024px) {
    .sidebar {
        transform: none !important;
        position: relative !important;
        width: 260px !important;
        min-width: 260px !important;
        height: auto !important;
    }
    
    .main-content {
        margin-left: 0 !important;
    }
}

@media (max-width: 480px) {
    .sidebar {
        width: 260px !important;
        min-width: 260px !important;
    }
}

/* Ensure admin-panel always shows both */
#admin-panel {
    display: flex !important;
    flex-direction: row !important;
}
    </style>
    <link rel="stylesheet" href="admin-layout.css">
</head>
<body class="bg-gray-50">

    <!-- Sidebar Overlay for Mobile -->
    

    <div id="admin-panel" style="display: flex;">
        <div id="sidebar-container"></div>
        <main class="main-content">
            <header class="bg-white border-b px-4 md:px-8 py-4 flex justify-between items-center sticky top-0 z-30">
                <div class="flex items-center gap-3">
                    <h2 class="text-lg md:text-xl font-bold text-gray-800 uppercase">Live Market Intelligence</h2>
                </div>
                <div id="syncStatus" class="text-xs font-bold text-green-600 px-3 py-1 bg-green-50 rounded-full flex items-center gap-2">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    LIVE DATA
                </div>
            </header>

            <div class="p-4 md:p-8 space-y-6 md:space-y-8">
                <div class="flex flex-wrap items-center gap-2 md:gap-3 bg-white p-3 md:p-4 rounded-xl shadow-sm">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider mr-2">History Range:</span>
                    <button onclick="updateRange(1)" class="range-btn active px-4 py-1.5 rounded-full border text-xs font-bold transition">1M</button>
                    <button onclick="updateRange(3)" class="range-btn px-4 py-1.5 rounded-full border text-xs font-bold transition">3M</button>
                    <button onclick="updateRange(6)" class="range-btn px-4 py-1.5 rounded-full border text-xs font-bold transition">6M</button>
                    <button onclick="updateRange(8)" class="range-btn px-4 py-1.5 rounded-full border text-xs font-bold transition">8M</button>
                    <button onclick="updateRange(12)" class="range-btn px-4 py-1.5 rounded-full border text-xs font-bold transition">1Y</button>
                    <button onclick="updateRange(36)" class="range-btn px-4 py-1.5 rounded-full border text-xs font-bold transition">3Y</button>
                    <button onclick="updateRange(60)" class="range-btn px-4 py-1.5 rounded-full border text-xs font-bold transition">5Y</button>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="card">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">24CT Gold Price / gm</h4>
                                <p class="text-xs text-gray-400 mt-0.5">SKJ rate per gram</p>
                            </div>
                            <span class="bg-yellow-100 text-yellow-700 text-xs font-bold px-2 py-1 rounded-full">24CT</span>
                        </div>
                        <p class="text-2xl font-black text-yellow-600 mb-3" id="live-gold24">₹--</p>
                        <div class="chart-container"><canvas id="gold24Chart"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">22CT Gold Price / gm</h4>
                                <p class="text-xs text-gray-400 mt-0.5">SKJ rate per gram</p>
                            </div>
                            <span class="bg-orange-100 text-orange-700 text-xs font-bold px-2 py-1 rounded-full">22CT</span>
                        </div>
                        <p class="text-2xl font-black text-orange-600 mb-3" id="live-gold22">₹--</p>
                        <div class="chart-container"><canvas id="gold22Chart"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">Silver Price / 10gm</h4>
                                <p class="text-xs text-gray-400 mt-0.5">SKJ rate per 10 grams</p>
                            </div>
                            <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded-full">SILVER</span>
                        </div>
                        <p class="text-2xl font-black text-gray-700 mb-3" id="live-silver">₹--</p>
                        <div class="chart-container"><canvas id="silverChart"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card border-t-4 border-gold text-center">
                        <p class="text-gray-500 text-xs font-bold uppercase mb-2">Total Enquiries</p>
                        <h3 class="text-4xl font-black text-royal-green" id="totalInquiries">0</h3>
                    </div>
                    <div class="card border-t-4 border-royal-green">
                        <p class="text-gray-500 text-xs font-bold uppercase mb-2">Category Popularity</p>
                        <div class="h-40 w-full"><canvas id="categoryChart"></canvas></div>
                    </div>
                    <div class="card border-t-4 border-blue-500 text-center">
                        <p class="text-gray-500 text-xs font-bold uppercase mb-2">Registered Users</p>
                        <h3 class="text-4xl font-black text-gray-800" id="totalUsers">0</h3>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="sidebar.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyATmseHSU3qimkm6pSCJ_xA1EL3_KiHtXs",
            authDomain: "skj-jewelry-store.firebaseapp.com",
            projectId: "skj-jewelry-store",
            storageBucket: "skj-jewelry-store.firebasestorage.app",
            messagingSenderId: "531463279637",
            appId: "1:531463279637:web:2ab8aaaa80211045252a1c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let chart24 = null, chart22 = null, chartSilver = null, catChart = null;
        let currentMonths = 1;

        

        window.logoutAdmin = async function() {
            await auth.signOut();
            window.location.href = 'login.html';
        };

        window.updateRange = function(months) {
            currentMonths = months;
            document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadPriceHistory(months);
        };

        auth.onAuthStateChanged(async (user) => {
            if (!user) { window.location.href = 'login.html'; return; }
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists || userDoc.data().role !== 'admin') {
                    window.location.href = 'index.html'; return;
                }
            } catch(e) { console.warn('admin check:', e); }
            document.getElementById('admin-panel').style.display = 'flex';
            initData();
        });

        function initData() {
            loadPriceHistory(1);
            loadCurrentPrices();

            // Total enquiries from orders collection
            db.collection('orders').onSnapshot((snap) => {
                document.getElementById('totalInquiries').textContent = snap.size;
            });

            // Category popularity from orders
            db.collection('orders').onSnapshot((snap) => {
                const cats = { 'Rings':0, 'Chains':0, 'Bangles':0, 'Others':0 };
                snap.forEach(d => {
                    const items = d.data().items || [];
                    items.forEach(item => {
                        const name = (item.name || '').toLowerCase();
                        if (name.includes('ring')) cats['Rings']++;
                        else if (name.includes('chain')) cats['Chains']++;
                        else if (name.includes('bangle')) cats['Bangles']++;
                        else cats['Others']++;
                    });
                });
                renderCatChart(cats);
            });

            // Users count
            db.collection('users').onSnapshot((snap) => {
                document.getElementById('totalUsers').textContent = snap.size;
            });
        }

        function loadCurrentPrices() {
            db.collection('prices').doc('current').onSnapshot((docSnap) => {
                if (!docSnap.exists) return;
                const d = docSnap.data();
                const fmt = (v) => v ? `₹${Number(v).toLocaleString('en-IN')}` : '₹--';
                document.getElementById('live-gold24').textContent = fmt(d.goldMarketPrice);
                document.getElementById('live-gold22').textContent = fmt(d.goldSKJPrice);
                document.getElementById('live-silver').textContent = fmt(d.silverMarketPrice);
            });
        }

        function loadPriceHistory(months) {
            const since = new Date();
            since.setMonth(since.getMonth() - months);

            db.collection('priceHistory')
              .where('updatedAt', '>=', since)
              .orderBy('updatedAt', 'asc')
              .onSnapshot((snap) => {
                const labels24 = [], data24 = [];
                const labels22 = [], data22 = [];
                const labelsSilver = [], dataSilver = [];

                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const dt = d.updatedAt?.toDate ? d.updatedAt.toDate() : new Date();
                    const label = dt.toLocaleDateString('en-IN', { day:'2-digit', month:'short' });

                    if (d.type === 'gold') {
                        labels24.push(label);
                        data24.push(d.marketPrice || 0);
                        labels22.push(label);
                        data22.push(d.skjPrice || 0);
                    } else if (d.type === 'silver') {
                        labelsSilver.push(label);
                        dataSilver.push(d.skjPrice || d.marketPrice || 0);
                    }
                });

                renderSingleChart('gold24Chart', labels24, data24, '#f59e0b', 'rgba(245,158,11,0.08)', '24CT Gold (₹/gm)', chart24, (c) => chart24 = c);
                renderSingleChart('gold22Chart', labels22, data22, '#ea580c', 'rgba(234,88,12,0.08)', '22CT Gold (₹/gm)', chart22, (c) => chart22 = c);
                renderSingleChart('silverChart', labelsSilver, dataSilver, '#64748b', 'rgba(100,116,139,0.08)', 'Silver (₹/10gm)', chartSilver, (c) => chartSilver = c);
            }, (err) => console.warn('priceHistory query error:', err));
        }

        function renderSingleChart(id, labels, data, color, bg, label, existingChart, setChart) {
            const ctx = document.getElementById(id)?.getContext('2d');
            if (!ctx) return;
            if (existingChart) existingChart.destroy();

            if (labels.length === 0) {
                // Show placeholder
                const canvas = document.getElementById(id);
                const pCtx = canvas.getContext('2d');
                pCtx.clearRect(0, 0, canvas.width, canvas.height);
                pCtx.fillStyle = '#cbd5e1';
                pCtx.font = '14px sans-serif';
                pCtx.textAlign = 'center';
                pCtx.fillText('No data for this range', canvas.width / 2, canvas.height / 2);
                setChart(null);
                return;
            }

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label,
                        data,
                        borderColor: color,
                        backgroundColor: bg,
                        fill: true,
                        tension: 0.4,
                        pointRadius: labels.length > 30 ? 0 : 3,
                        pointHoverRadius: 5,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `₹${ctx.raw.toLocaleString('en-IN')}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: (v) => `₹${Number(v).toLocaleString('en-IN')}`,
                                font: { size: 10 }
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            ticks: { maxRotation: 45, font: { size: 9 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            setChart(chart);
        }

        function renderCatChart(data) {
            const ctx = document.getElementById('categoryChart')?.getContext('2d');
            if (!ctx) return;
            if (catChart) catChart.destroy();
            catChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{ data: Object.values(data), backgroundColor: ['#D4AF37','#004d40','#1a3a34','#94a3b8'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>